name: MicroLib CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # Job 1: Testing All Services
  test:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    - name: Install & Test User Service
      run: |
        cd user-service
        npm install
        npm test -- --forceExit
        
    - name: Install & Test Book Service
      run: |
        cd book-service
        npm install
        npm test -- --forceExit
        
    - name: Install & Test Loan Service
      run: |
        cd loan-service
        npm install
        npm test -- --forceExit

  # Job 2: Build & Push (Simulated Deployment)
  build-and-deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Only deploy on main branch
    
    steps:
    - uses: actions/checkout@v3

    # Log in to Docker Hub (Requires Secrets: DOCKER_USERNAME, DOCKER_PASSWORD)
    - name: Log in to Docker Hub
      id: login
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
      continue-on-error: true 

    - name: Build User Service
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/microlib-user:latest ./user-service

    - name: Build Book Service
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/microlib-book:latest ./book-service

    - name: Build Loan Service
      run: docker build -t ${{ secrets.DOCKER_USERNAME }}/microlib-loan:latest ./loan-service

    - name: Push Images
      if: steps.login.outcome == 'success'
      run: |
        docker push ${{ secrets.DOCKER_USERNAME }}/microlib-user:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/microlib-book:latest
        docker push ${{ secrets.DOCKER_USERNAME }}/microlib-loan:latest
